<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MC-ED Control</title>
    <link rel="stylesheet" href="./control.css">
</head>
<body x-data="controlPanel()"
      @add-widget-to-grid.window="addWidget($event.detail)"
      @remove-widget-from-grid.window="removeWidget($event.detail.powerId)"  >

    <header>
        <h1>MC-ED Control Panel</h1>
            <button x-show="isEditing" @click="refreshPowersData(); $dispatch('open-library-modal')">+ Add Widget</button>
            <button @click="isEditing = !isEditing" x-text="isEditing ? 'Done' : 'Edit Layout'"></button>
    </header>

    <template x-teleport="body">
        <div x-data="{ isOpen: false }"
             @open-library-modal.window="isOpen = true"
             @control-mode-changed.window="isOpen = false"
             @keydown.escape.window="isOpen = false"
             class="modal-root">

            <div x-show="isOpen" x-cloak class="modal-overlay" @click="isOpen = false"></div>
            <div x-show="isOpen" x-cloak class="modal-content" x-transition>
                <h2>Add Power to Grid</h2>
                <div id="control-library-list"
                     hx-get="/api/control/powers_library" hx-trigger="open-library-modal from:window"
                     hx-swap="innerHTML">
                    <p>Loading...</p>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" @click="isOpen = false">Close</button>
                </div>
            </div>
        </div>
    </template>
    <main>
        <div id="power-grid" x-ref="powerGrid"  :style="`grid-template-columns: repeat(${layout.grid.columns}, 1fr)`">
            <template x-for="widget in layout.widgets" :key="widget.power_id">
                <div class="power-widget"
                     :id="`widget-${power.power_id}`"
                     x-data="powerWidget(powers[widget.power_id])"
                     @update-status.stop="updateStatus($event.detail.status, $event.detail.executionId, $event.detail.message)"
                     :class="{ 'is-running': status === 'running', 'has-error': status === 'error' }">

                    <div class="power-header">
                        <span class="power-name" x-text="power.name"></span>
                        <button class="remove-widget-btn"
                                x-show="isEditing"
                                @click.stop="$dispatch('remove-widget-from-grid', { powerId: power.power_id })"
                                title="Remove From Grid">
                            &times;
                        </button>
                    </div>

                    <form class="power-params" :id="`form-${power.power_id}`">
                        <template x-for="param in power.parameters" :key="param.name">
                            <div class="param-control">
                                <label x-text="param.name + ':'"></label>

                                <template x-if="param.type === 'Number'">
                                    <div class="param-slider">
                                        <input type="range" :name="param.name" x-model="formValues[param.name]" min="1" max="100">
                                        <output x-text="formValues[param.name]"></output>
                                    </div>
                                </template>

                                <template x-if="param.type === 'Block'">
                                    <select :name="param.name" x-model="formValues[param.name]">
                                        <option value="STONE">Stone</option>
                                        <option value="OAK_PLANKS">Oak Planks</option>
                                        <option value="GLASS">Glass</option>
                                        <option value="DIAMOND_BLOCK">Diamond Block</option>
                                    </select>
                                </template>

                                </div>
                        </template>
                    </form>

<!--                    <div class="power-status" x-text="status === 'error' ? `Error: ${errorMessage}` : `Status: ${status}`">Status: Idle</div>-->

                    <div class="widget-main-actions" :id="`actions-${power.power_id}`">
<!--                        <button class="execute-btn"-->
<!--                                :disabled="status === 'running'"-->
<!--                                hx-post="/api/execute_power"-->
<!--                                :hx-include="`#form-${power.power_id}`"-->
<!--                                :hx-vals="`js:{power_id: '${power.power_id}'}`">-->
<!--&lt;!&ndash;                                hx-target="this"&ndash;&gt;-->
<!--&lt;!&ndash;                                hx-swap="outerHTML">&ndash;&gt;-->
<!--                            Execute-->
<!--                        </button>-->
                            <button class="execute-btn"
                                :disabled="status === 'running'"
                                hx-post="/api/execute_power"
                                :hx-include="`#form-${power.power_id}`"
                                :hx-vals="`js:{power_id: '${power.power_id}'}`"
                                :hx-target="`#actions-${power.power_id}`"
                                hx-swap="outerHTML">
                            Execute
                            </button>

                        <template x-if="status === 'running' && currentExecutionId">
                            <button class="btn-small btn-danger cancel-btn"
                                    hx-post="/api/cancel_power"
                                    hx-ext="json-enc"
                                    :hx-vals="`{ 'execution_id': '${currentExecutionId}' }`">
                                Cancel
                            </button>
                        </template>
                    </div>
                </div>
<!--                <div class="power-widget"-->
<!--                     x-data="powerWidget(powers[widget.power_id])"-->
<!--                     @update-status.stop="updateStatus($event.detail.status, $event.detail.message)"-->
<!--                     :class="{ 'is-running': status === 'running', 'has-error': status === 'error' }"-->
<!--                     :id="`widget-${power.power_id}`">-->

<!--                    <div class="power-header">-->
<!--                        <span class="power-name" x-text="power.name"></span>-->
<!--                        <button class="remove-widget-btn"-->
<!--                            x-show="showAdminControls"-->
<!--                            @click.stop="$dispatch('remove-widget-from-grid', { powerId: power.power_id })"-->
<!--                            x-transition>-->
<!--                            &times;-->
<!--                        </button>-->
<!--                    </div>-->

<!--                    <form class="power-params" :id="`form-${power.power_id}`">-->
<!--                        <template x-for="param in power.parameters" :key="param.name">-->
<!--                            <div class="param-control">-->
<!--                                <label x-text="param.name + ':'"></label>-->

<!--                                <template x-if="param.type === 'Number'">-->
<!--                                    <div class="param-slider">-->
<!--                                        <input type="range" :name="param.name" x-model="formValues[param.name]" min="1" max="100">-->
<!--                                        <output x-text="formValues[param.name]"></output>-->
<!--                                    </div>-->
<!--                                </template>-->
<!--                                </div>-->
<!--                        </template>-->
<!--                    </form>-->

<!--                    <div class="power-status" x-text="status === 'error' ? `Error: ${errorMessage}` : `Status: ${status}`">Status: Idle</div>-->

<!--                   <button class="execute-btn"-->
<!--                        :disabled="status === 'running'"-->
<!--                        hx-post="/api/execute_power"-->
<!--                        :hx-include="`#form-${power.power_id}`"-->
<!--                        :hx-vals="`js:{power_id: '${power.power_id}'}`"-->
<!--                        hx-target="this"-->
<!--                        hx-swap="outerHTML">-->
<!--                        Execute-->
<!--                    </button>-->
<!--                </div>-->
            </template>
        </div>
    </main>
    <script type="module" src="./control.js"></script>
</body>
</html>